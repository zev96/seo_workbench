# 知乎监测功能 v2.1 更新日志

## 更新日期：2025-12-03

---

## 🎯 本次更新重点

### 问题1：检测数量不足 ✅ 已修复
**现象**：设置Top 20但只检测了5个回答

**根本原因**：
- 知乎采用懒加载机制，初始只加载少量回答
- 需要滚动页面才能触发更多内容加载

**解决方案**：
```python
# 新增自动滚动逻辑
while scroll_attempts < 5:
    # 滚动到底部
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(1.5)  # 等待加载
    
    # 检查是否加载了新内容
    answers = driver.find_elements(By.CLASS_NAME, 'List-item')
    
    # 如果已经有足够的回答，停止滚动
    if len(answers) >= check_range:
        break
```

**效果**：
- ✅ 现在可以正确加载Top 20的回答
- ✅ 最多滚动5次，避免无限循环
- ✅ 达到目标数量后自动停止

---

### 问题2：详情页Top10透视表无数据 ✅ 已修复
**现象**：点击"详情"后，Top10透视表显示"查无数据"

**根本原因**：
- Phase 1基础检测只保存了排名数组
- 没有保存Top10的详细数据（答主、赞同数、评论数等）
- 详情页从数据库读取快照为空

**解决方案**：

#### 1. 在基础检测时同步抓取Top10详细数据
```python
# 扫描前N个回答时，如果是Top10，收集详细信息
if rank <= 10:
    # 提取答主
    author = answer_elem.find_element(...).text
    
    # 提取赞同数
    vote_count = self._parse_vote_count(vote_elem.text)
    
    # 提取评论数
    comment_count = self._parse_comment_count(comment_elem.text)
    
    # 品牌归属
    mentioned_brand = target_brand if matched else "未提及"
    
    # 保存到top10_details列表
    top10_details.append({
        'rank': rank,
        'author': author,
        'mentioned_brand': mentioned_brand,
        'vote_count': vote_count,
        'comment_count': comment_count,
        'summary': content_text[:50]
    })
```

#### 2. 返回结果包含Top10快照
```python
result = {
    'question_title': question_title,
    'total_views': total_views,
    'total_followers': total_followers,
    'found_ranks': found_ranks,
    'top10_snapshot': {  # 新增！
        'top10': top10_details,
        'scan_at': datetime.now().isoformat()
    },
    'status': 'success',
    'check_at': datetime.now().isoformat()
}
```

#### 3. 保存到数据库
```python
# 在 _on_task_completed 方法中
if 'top10_snapshot' in result:
    task.set_snapshot(result['top10_snapshot'])
    logger.info(f"已保存Top10快照，包含 {len(result['top10_snapshot'].get('top10', []))} 条数据")
```

**效果**：
- ✅ 立即检测时一次性抓取所有数据
- ✅ 详情页直接从数据库读取，无需重新爬取
- ✅ 定时任务也会自动保存Top10数据
- ✅ 刷新按钮仍然有效，可以重新抓取最新数据

---

## 📊 新增功能

### 1. 智能滚动加载
- 自动滚动页面触发懒加载
- 最多滚动5次，防止死循环
- 实时日志显示加载进度

### 2. Top10详细数据收集
- **答主信息**：提取答主昵称
- **赞同数**：支持"1.2K"、"1.2万"等格式
- **评论数**：从按钮文本提取数字
- **品牌归属**：自动识别我方品牌
- **回答摘要**：保存前50字

### 3. 增强的数据解析
新增两个辅助方法：
- `_parse_vote_count()`：解析赞同数
- `_parse_comment_count()`：解析评论数

---

## 🔧 技术改进

### 代码优化
1. **滚动逻辑**：
   ```python
   # 检测页面高度变化
   last_height = driver.execute_script("return document.body.scrollHeight")
   # 滚动后对比
   new_height = driver.execute_script("return document.body.scrollHeight")
   if new_height == last_height:
       break  # 页面不再增长，停止滚动
   ```

2. **容错处理**：
   - 每个字段提取都有try-except
   - 提取失败时使用默认值（0或"未知"）
   - 不会因为单个字段失败而中断整个流程

3. **日志增强**：
   ```
   滚动 1 次，找到 5 个回答
   滚动 2 次，找到 12 个回答
   滚动 3 次，找到 20 个回答
   滚动完成，共找到 20 个回答
   Top10数据 - 第1名: 张三, 品牌:未提及, 赞同:1234
   检测完成: 找到2个排名, 收集10条Top10数据
   ```

---

## 📈 性能影响

### 检测时间变化
- **之前**：约10-15秒/任务
- **现在**：约20-30秒/任务（增加了滚动和数据提取）

### 数据量变化
- **之前**：只保存排名数组（几十字节）
- **现在**：保存Top10完整数据（约2-3KB）

### 建议
- 请求间隔建议增加到 **4-8秒**
- 避免频繁检测，建议每天1-2次

---

## 🧪 测试清单

### 测试步骤
1. ✅ 添加监控任务（设置Top 20）
2. ✅ 点击"立即检测"
3. ✅ 观察日志：
   - 应该看到"滚动X次"的日志
   - 应该看到"找到20个回答"
   - 应该看到"Top10数据"的日志
   - 应该看到"收集10条Top10数据"
4. ✅ 点击"📊 详情"
5. ✅ 验证Top10透视表有数据：
   - 排名：1-10
   - 提及品牌：显示品牌名或"未提及"
   - 赞同数：显示数字
   - 评论数：显示数字
   - 答主/摘要：显示内容

### 预期结果
```
流量概览：
- 浏览量：9.8万
- 关注者：65
- 我方排名：第2,3,5名
- 最后更新：2025-12-03 15:57

Top 10 排名透视：
排名 | 提及品牌 | 赞同数 | 评论数 | 答主/摘要
-----|---------|--------|--------|----------
1    | 未提及   | 1234   | 56     | 张三 - 这是一个很好的回答...
2    | CEWEY   | 2345   | 78     | 李四 - 我推荐CEWEY品牌...
...
```

---

## ⚠️ 已知限制

### 1. 滚动次数限制
- 最多滚动5次
- 如果问题有超过100个回答，可能无法全部加载
- **解决**：可以在代码中调整 `max_scrolls` 参数

### 2. 品牌识别简化
- 基础检测只识别目标品牌（我方品牌）
- 不识别竞品品牌
- **原因**：避免增加检测时间
- **解决**：点击"详情"后使用"刷新数据"进行完整扫描

### 3. 知乎反爬
- 滚动和数据提取会增加检测时间
- 可能更容易触发反爬机制
- **建议**：
  - 增加请求间隔（4-8秒）
  - 减少检测频率
  - 使用有效的Cookie

---

## 🔮 下一步计划

### v2.2（计划中）
- [ ] 竞品品牌识别（在基础检测中）
- [ ] 更智能的滚动策略
- [ ] 支持检测Top 50
- [ ] 添加进度百分比显示

### v3.0（远期）
- [ ] 支持多问题批量检测
- [ ] 排名趋势图表
- [ ] 自动生成竞品分析报告
- [ ] 微信/邮件通知

---

## 📞 问题反馈

如果遇到问题，请提供：
1. 完整的日志文件
2. 监控的知乎问题URL
3. 详情页截图
4. 是否设置了Cookie

---

**更新状态**：✅ 已完成  
**测试状态**：⏳ 待用户验证  
**版本号**：v2.1  
**发布日期**：2025-12-03

