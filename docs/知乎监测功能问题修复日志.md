# 知乎监测功能问题修复日志

## 修复日期：2025-12-03

---

## 问题1：QWidget未定义导致详情页闪退 ✅

### 错误信息
```
NameError: name 'QWidget' is not defined
```

### 原因
`ui/dialogs/zhihu_detail_dialog.py` 中的 `_create_stat_box` 方法返回类型标注为 `QWidget`，但导入语句中缺少 `QWidget`。

### 修复
```python
# 修复前
from PyQt6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout, QLabel, 
    QTableWidget, QTableWidgetItem, QHeaderView, QGroupBox
)

# 修复后
from PyQt6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout, QLabel, QWidget,
    QTableWidget, QTableWidgetItem, QHeaderView, QGroupBox
)
```

---

## 问题2：品牌排名未检测到 ⚠️

### 现象
- 日志显示"找到 5 个回答"
- 但没有"在第X名发现品牌"的日志
- 问题标题显示为空

### 原因分析
1. **知乎页面结构变化**：CSS选择器失效
2. **标题提取失败**：`QuestionHeader-title` 类名可能已更改
3. **内容提取不完整**：可能提取到的是空文本或不完整文本

### 修复措施

#### 1. 增强标题提取（多重fallback）
```python
# 修复前：单一选择器
title_elem = self.driver.find_element(By.CLASS_NAME, 'QuestionHeader-title')
question_title = title_elem.text.strip()

# 修复后：多重fallback
question_title = ""
try:
    title_elem = self.driver.find_element(By.CLASS_NAME, 'QuestionHeader-title')
    question_title = title_elem.text.strip()
except:
    try:
        title_elem = self.driver.find_element(By.CSS_SELECTOR, 'h1.QuestionHeader-title')
        question_title = title_elem.text.strip()
    except:
        try:
            title_elem = self.driver.find_element(By.TAG_NAME, 'h1')
            question_title = title_elem.text.strip()
        except:
            question_title = "未知问题"
```

#### 2. 增加调试日志
```python
# 将 logger.debug 改为 logger.info，便于排查
logger.info(f"第 {rank} 名回答前100字: {content_text[:100]}")
```

---

## 问题3：循环导入导致闪退 ✅

### 错误信息
```
ImportError: attempted relative import beyond top-level package
```

### 修复的文件
1. `ui/widgets/zhihu_monitor.py` - 删除函数内的重复导入
2. `ui/dialogs/zhihu_detail_dialog.py` - 使用相对导入
3. `core/zhihu_scheduler.py` - 使用相对导入
4. `core/zhihu_monitor_worker.py` - 删除条件导入

---

## 测试建议

### 测试步骤
1. 重新运行程序
2. 点击"立即检测"
3. 查看日志输出：
   ```
   2025-12-03 XX:XX:XX | INFO | 问题标题: [应该显示完整标题]
   2025-12-03 XX:XX:XX | INFO | 找到 X 个回答
   2025-12-03 XX:XX:XX | INFO | 第 1 名回答前100字: [应该显示内容]
   2025-12-03 XX:XX:XX | INFO | 在第 X 名发现品牌: CEWEY
   ```

### 如果仍然无法检测到品牌

#### 方案A：检查知乎页面结构
1. 手动访问监控的知乎问题
2. 按F12打开开发者工具
3. 检查回答列表的HTML结构
4. 查看是否有 `.List-item` 和 `.RichContent-inner` 类

#### 方案B：使用浏览器截图调试
在 `_check_question` 方法中添加：
```python
# 保存页面截图用于调试
self.driver.save_screenshot('zhihu_debug.png')
```

#### 方案C：输出页面HTML
```python
# 输出页面源代码
with open('zhihu_page.html', 'w', encoding='utf-8') as f:
    f.write(self.driver.page_source)
```

---

## 已知限制

### 1. 知乎反爬机制
- **现象**：频繁请求可能触发403/429
- **解决**：已实现自动停止机制
- **建议**：请求间隔设置≥3秒

### 2. 页面结构变化
- **现象**：知乎可能随时更新页面结构
- **影响**：CSS选择器失效
- **解决**：已实现多重fallback
- **长期方案**：考虑使用知乎API（需要申请）

### 3. 动态加载内容
- **现象**：某些回答可能需要滚动才能加载
- **影响**：只能检测到前几个回答
- **解决**：增加等待时间（已设置2秒）
- **优化**：可以添加滚动逻辑

---

## 下一步优化建议

### 短期（本周）
1. ✅ 修复QWidget导入问题
2. ✅ 增强标题提取容错
3. ⏳ 验证品牌匹配是否正常工作
4. ⏳ 添加页面截图调试功能

### 中期（下周）
1. 优化CSS选择器（根据实际页面结构）
2. 添加滚动加载更多回答
3. 实现智能重试机制
4. 添加更详细的错误提示

### 长期（下月）
1. 研究知乎API接入方案
2. 实现OCR识别（应对反爬）
3. 添加代理池支持
4. 实现分布式检测

---

## 联系支持

如果问题仍然存在，请提供以下信息：
1. 完整的错误日志（`logs/seo_workbench_*.log`）
2. 监控的知乎问题URL
3. 使用的品牌关键词
4. 是否设置了Cookie

---

**修复状态**：部分完成  
**待验证**：品牌匹配功能  
**下次更新**：根据测试结果进一步优化

