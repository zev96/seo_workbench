# 知乎监测功能修复说明

**修复日期**: 2025-12-03  
**版本**: v2.4

---

## 🐛 修复的问题

### 问题1：主页面列标题错误

**现象**: 主页面表格显示"问题标题"，但实际内容是问题链接URL  
**影响**: 用户可能误解列的含义

**修复方案**:
- 将列标题从 "问题标题" 改为 "问题链接"
- 导出Excel时也相应调整列名

### 问题2：问题详情中缺少标题和描述

**现象**: 在"详情分析"对话框中，没有显示问题的标题和描述  
**影响**: 用户无法直观了解问题的具体内容

**修复方案**:
1. 在爬虫中添加问题描述提取逻辑
2. 数据库模型添加 `question_detail` 字段
3. 详情对话框显示问题标题和描述
4. 添加数据库迁移脚本

---

## 📝 修改文件列表

### 1. UI层修改

#### `ui/widgets/zhihu_monitor.py`
```python
# 修改列标题
self.table.setHorizontalHeaderLabels([
    "☐", "问题链接", "目标品牌", "状态", "排名", "浏览量/关注", "最后更新", "操作"
])

# 任务完成回调中保存问题描述
task.question_detail = result.get('question_detail', '')
```

#### `ui/dialogs/zhihu_detail_dialog.py`
```python
# 显示问题标题和描述
title_label = QLabel(f"<b>问题:</b> {self.task.question_title or '未知'}")

# 如果有描述，显示问题描述
question_detail = self.task.question_detail if hasattr(self.task, 'question_detail') else None
if question_detail:
    detail_label = QLabel(f"<b>描述:</b> {question_detail}")
```

### 2. 爬虫层修改

#### `core/zhihu_monitor_worker.py`

**常规检测函数 `_check_question`**:
```python
# 提取问题描述（问题补充说明）
question_detail = ""
try:
    # 尝试多种选择器
    detail_elem = self.driver.find_element(By.CLASS_NAME, 'QuestionRichText')
    question_detail = detail_elem.text.strip()
except:
    try:
        detail_elem = self.driver.find_element(By.CSS_SELECTOR, '.QuestionHeader-detail .RichText')
        question_detail = detail_elem.text.strip()
    except:
        # 更多容错选择器...
        question_detail = ""

# 添加到返回结果
result = {
    'question_title': question_title,
    'question_detail': question_detail,  # 新增
    'total_views': total_views,
    # ...
}
```

**详情扫描函数 `_scan_question_detail`**:
```python
# 提取问题描述
question_detail = ""
try:
    detail_elem = self.driver.find_element(By.CLASS_NAME, 'QuestionRichText')
    question_detail = detail_elem.text.strip()
except:
    # 容错处理...
    pass

logger.info(f"问题描述: {question_detail[:100] if question_detail else '(无)'}")
```

### 3. 数据库层修改

#### `database/models.py`
```python
class ZhihuMonitorTask(Base):
    """知乎监测任务表"""
    
    id = Column(Integer, primary_key=True)
    question_url = Column(String(500), nullable=False)
    question_title = Column(String(200))
    question_detail = Column(Text)  # 新增字段
    target_brand = Column(String(100), nullable=False)
    # ...
```

#### `database/migrations.py`

**新增迁移函数**:
```python
def _migrate_zhihu_tasks_question_detail(cursor, conn):
    """添加问题描述字段"""
    cursor.execute("PRAGMA table_info(zhihu_monitor_tasks)")
    columns = [row[1] for row in cursor.fetchall()]
    
    if 'question_detail' not in columns:
        cursor.execute("""
            ALTER TABLE zhihu_monitor_tasks 
            ADD COLUMN question_detail TEXT
        """)
        conn.commit()
        logger.success("✅ 已添加字段: question_detail")
```

**更新迁移检查**:
```python
def check_migration_needed(db_path: str) -> bool:
    # 检查 zhihu_monitor_tasks 表的新字段
    cursor.execute("PRAGMA table_info(zhihu_monitor_tasks)")
    task_columns = [row[1] for row in cursor.fetchall()]
    needs_migration = needs_migration or 'question_detail' not in task_columns
    
    return needs_migration
```

---

## 🎯 知乎问题页面元素选择器

### 问题标题
```python
# 选择器优先级
1. By.CLASS_NAME, 'QuestionHeader-title'
2. By.CSS_SELECTOR, 'h1.QuestionHeader-title'
3. By.TAG_NAME, 'h1'
```

### 问题描述
```python
# 选择器优先级
1. By.CLASS_NAME, 'QuestionRichText'
2. By.CSS_SELECTOR, '.QuestionHeader-detail .RichText'
3. By.CSS_SELECTOR, 'div[class*="QuestionRichText"]'
```

**说明**: 
- 知乎问题页面可能有或没有问题描述
- 使用多个选择器确保兼容性
- 如果找不到描述，返回空字符串（不影响主流程）

---

## ✅ 测试验证

### 测试场景

1. **新任务添加**
   - 添加知乎问题链接
   - 执行检测
   - ✅ 验证：问题标题和描述正确提取并保存

2. **已存在任务检测**
   - 对已有任务重新检测
   - ✅ 验证：问题描述更新到数据库

3. **详情分析**
   - 打开任务详情对话框
   - ✅ 验证：显示问题标题和描述
   - 点击"刷新数据"
   - ✅ 验证：问题描述刷新

4. **数据库迁移**
   - 使用旧数据库（无 question_detail 字段）
   - 启动程序
   - ✅ 验证：自动添加新字段

5. **无描述问题**
   - 测试没有补充说明的知乎问题
   - ✅ 验证：不显示描述区域，不报错

---

## 🔄 兼容性

### 向后兼容
- ✅ 旧数据库自动迁移添加新字段
- ✅ 已存在的任务不受影响
- ✅ 问题描述为空时不影响显示

### 数据安全
- ✅ 迁移前检查字段是否存在
- ✅ 迁移失败不影响程序运行
- ✅ 原有数据完整保留

---

## 📊 数据库结构变更

### 字段详情

| 字段 | 类型 | 说明 | 可为空 |
|-----|------|-----|--------|
| question_detail | TEXT | 问题描述/补充说明 | ✅ |

### SQL语句
```sql
ALTER TABLE zhihu_monitor_tasks 
ADD COLUMN question_detail TEXT;
```

---

## 🎨 UI效果

### 修改前
```
列标题: ☐ | 问题标题 | 目标品牌 | ...
内容:    ☐ | https://www.zhihu.com/question/123456 | CEWEY | ...
        (列名与内容不符，容易误解)
        
详情对话框:
  [问题: 未知]
  (缺少问题信息)
```

### 修改后
```
列标题: ☐ | 问题链接 | 目标品牌 | ...
内容:    ☐ | https://www.zhihu.com/question/123456 | CEWEY | ...
        (列名与内容一致，清晰明了)
        
详情对话框:
  [问题: 洗地机和扫地机器人哪个更好用？]
  [描述: 家里有宠物，不知道选哪个更合适...]
  (完整显示问题信息)
```

---

## 💡 使用说明

### 对于新用户
1. 添加监控任务后，系统会自动提取问题标题和描述
2. 在主列表中，"问题链接"列显示URL
3. 点击"详情"可查看完整的问题标题和描述

### 对于已有用户
1. 程序会自动执行数据库迁移（首次启动时）
2. 已存在的任务重新检测后会更新问题描述
3. 无需手动操作，自动兼容

---

## ⚠️ 注意事项

1. **问题描述可选**: 部分知乎问题没有补充说明，属正常现象
2. **迁移自动执行**: 数据库迁移在程序启动时自动检测和执行
3. **性能影响**: 提取问题描述不影响爬虫性能
4. **错误容错**: 即使提取描述失败，也不影响其他功能

---

## 🚀 后续优化建议

1. **智能摘要**: 对过长的问题描述自动生成摘要
2. **关键词提取**: 从问题标题和描述中提取关键词
3. **相关性分析**: 基于问题描述进行品牌相关性评分
4. **批量导出**: 导出Excel时包含完整的问题描述

---

**修复完成，可以正常使用！** 🎉

