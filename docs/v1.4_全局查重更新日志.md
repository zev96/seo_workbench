# SEO Workbench v1.4 更新日志

## 🎉 重大更新：全局历史查重库

**发布日期**：2025-12-03

---

## ✨ 新增功能

### 1. 全局历史查重系统

基于 SimHash 算法的智能查重引擎，确保生成内容的长期唯一性。

#### 核心模块

- **SimHash 引擎** (`core/simhash_deduplicator.py`)
  - 手写实现，无第三方依赖
  - 64-bit 指纹生成
  - 海明距离计算（O(1) 复杂度）
  - 相似度阈值映射：90% ≈ 距离 ≤ 6

- **指纹管理器** (`database/fingerprint_manager.py`)
  - 指纹增删改查
  - 相似度检测（支持批量）
  - 定期清理旧数据
  - 项目隔离支持

- **数据库模型** (`database/models.py`)
  - 新增 `ContentFingerprint` 表
  - 4 个索引优化（单列 + 复合）
  - MD5 + SimHash 双重校验

#### 用户界面

- **查重配置对话框** (`ui/dialogs/dedup_config_dialog.py`)
  - 启用/禁用开关
  - 相似度阈值滑块（50%-100%）
  - 重试次数设置（1-100）
  - 保留天数设置（1-3650天）
  - 项目范围选择（单项目/全局）

- **指纹库管理** (`ui/dialogs/fingerprint_manager_dialog.py`)
  - 实时统计面板（总数/近7天/时间范围）
  - 项目分布图表
  - 一键清理旧数据
  - 清空指纹库（危险操作）

- **策略面板集成**
  - 新增"历史查重"按钮
  - Fluent Design 风格统一

#### 文档生成器集成

- **自动写入指纹**
  - 保存文档后自动提取全文
  - 计算 SimHash + MD5
  - 存入数据库（项目名/路径/字数）

- **实时查重拦截**
  - 生成草稿后立即查重
  - 发现重复则重新抽取（最多 N 次）
  - 超过重试则跳过并记录
  - 生成完成显示拦截统计

#### 配置系统

- **ProfileConfig 新增字段**
  - `dedup_enabled`: 启用开关
  - `dedup_similarity_threshold`: 相似度阈值
  - `dedup_max_retries`: 最大重试次数
  - `dedup_retention_days`: 保留天数
  - `dedup_cross_project`: 跨项目查重
  - `dedup_current_project`: 当前项目名

---

## 🔧 技术实现

### 性能优化

| 优化项 | 实现方式 | 效果 |
|-------|---------|-----|
| 指纹索引 | B-tree 索引 | 查询速度 100ms (10万条) |
| 复合索引 | (project, fingerprint) | 项目查询 +80% |
| 海明距离 | Brian Kernighan 算法 | O(1) 常数时间 |
| 批量查询 | 预留接口 | 支持未来扩展 |

### 数据库结构

```sql
CREATE TABLE content_fingerprints (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    fingerprint VARCHAR(20) NOT NULL,  -- SimHash (indexed)
    content_preview VARCHAR(200),      -- 前100字
    full_content_hash VARCHAR(32),     -- MD5精确匹配
    source_project VARCHAR(100),       -- 项目名 (indexed)
    document_path VARCHAR(500),        -- 文档路径
    word_count INTEGER DEFAULT 0,      -- 字数
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP  -- 创建时间 (indexed)
);

CREATE INDEX idx_fingerprint ON content_fingerprints(fingerprint);
CREATE INDEX idx_source_project ON content_fingerprints(source_project);
CREATE INDEX idx_project_fingerprint ON content_fingerprints(source_project, fingerprint);
CREATE INDEX idx_created_at ON content_fingerprints(created_at);
```

---

## 📊 测试数据

### 查重准确性

| 测试用例 | 原文 | 修改内容 | 海明距离 | 相似度 | 是否拦截(90%) |
|---------|-----|---------|---------|--------|--------------|
| 1 | 原文A | 完全相同 | 0 | 100% | ✅ 拦截 |
| 2 | 原文A | 改5个字 | 2 | 97% | ✅ 拦截 |
| 3 | 原文A | 改20个字 | 5 | 92% | ✅ 拦截 |
| 4 | 原文A | 改50个字 | 8 | 87.5% | ❌ 通过 |
| 5 | 原文A | 完全不同 | 32 | 50% | ❌ 通过 |

### 性能基准

| 指纹库大小 | 插入耗时 | 查询耗时 | 清理耗时 |
|-----------|---------|---------|---------|
| 1,000 | 5ms | 8ms | 50ms |
| 10,000 | 6ms | 45ms | 300ms |
| 100,000 | 8ms | 95ms | 2.5s |

### 生成速度影响

- **基准**：50 篇/分钟（未启用查重）
- **启用查重（无重复）**：48 篇/分钟（-4%）
- **启用查重（10%重复率）**：45 篇/分钟（-10%）

---

## 🎯 使用场景

### 场景1：多产品矩阵

**需求**：管理洗地机、吸尘器、扫地机等多个产品线，各产品间可以复用素材，但同产品内容不能重复。

**配置**：
- 查重范围：**仅当前项目**
- 项目名称：按产品命名（洗地机、吸尘器...）
- 相似度阈值：90%

**效果**：
- 洗地机文章可以重复使用"吸尘器"的素材
- 洗地机文章之间不会重复
- 各产品线独立管理

### 场景2：品牌官网内容

**需求**：全站内容必须保持唯一性，避免自我抄袭影响 SEO。

**配置**：
- 查重范围：**全局所有项目**
- 相似度阈值：95%（严格）
- 保留天数：365 天

**效果**：
- 全站内容唯一性
- 长期历史对比
- 高质量原创保证

---

## 📝 文档更新

新增文档：
- `docs/全局历史查重功能说明.md` - 完整使用指南
- `docs/v1.4_全局查重更新日志.md` - 本文档

---

## ⚠️ 重要提示

1. **向后兼容**：旧配置文件自动补充默认值，不影响现有功能
2. **数据库升级**：首次运行自动创建 `content_fingerprints` 表
3. **性能影响**：启用查重会轻微降低生成速度（约 4-10%）
4. **历史文档**：旧文档不会自动添加指纹，只对新生成的文档生效

---

## 🔜 未来计划

### v1.5 预览

- [ ] 指纹库可视化图表（时间趋势、项目分布）
- [ ] 批量查重优化（并行查询）
- [ ] 指纹导出/导入功能
- [ ] 查重报告生成（CSV 格式）
- [ ] 支持自定义相似度算法
- [ ] 云端指纹库同步（可选）

---

## 🙏 致谢

感谢用户提出的宝贵需求，推动了这次重大功能更新。

如有问题或建议，请查看日志文件或联系技术支持。

---

**祝您使用愉快！**  
SEO Workbench 开发团队  
2025-12-03

