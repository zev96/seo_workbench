# 全局历史查重功能说明

## 📋 功能概述

**全局历史查重库 (Global Deduplication)** 是一个基于 SimHash 算法的内容去重系统，用于确保生成的文章在长期范围内保持唯一性。

### 核心特性

✅ **SimHash 指纹技术**：为每篇文章生成 64-bit 唯一指纹  
✅ **海明距离比对**：快速计算内容相似度（10万条记录 < 100ms）  
✅ **自动拦截重复**：生成时实时查重，重复则重新抽取  
✅ **项目隔离支持**：支持跨项目或单项目查重  
✅ **定期清理机制**：自动清理旧指纹（默认保留半年）

---

## 🎯 使用流程

### 1️⃣ 启用查重功能

1. 点击左侧策略面板的 **"历史查重"** 按钮
2. 勾选 **"启用历史查重"** 开关
3. 配置参数：
   - **相似度阈值**：默认 90%（推荐）
     - 90% = 海明距离 ≤ 6
     - 95% = 海明距离 ≤ 3
     - 98% = 海明距离 ≤ 1
   - **最大重试次数**：默认 10 次
   - **指纹保留天数**：默认 180 天（半年）
   - **查重范围**：
     - **仅当前项目**：只对比同项目的历史文章
     - **全局所有项目**：对比所有历史文章
   - **项目名称**：输入当前项目标识（如：产品A、类目B）

4. 点击 **"保存配置"**

### 2️⃣ 生成文章时自动查重

启用查重后，在 **"随机混排"** 模式生成文章时：

1. **生成草稿** → 计算 SimHash 指纹
2. **数据库比对** → 查找相似记录
3. **判断结果**：
   - ✅ **未重复**：保存文档 + 写入指纹
   - ⚠️ **检测重复**：丢弃当前组合，重新抽取（最多重试 10 次）
   - ❌ **超过重试次数**：跳过该篇，记录警告

4. **生成完成**：日志显示拦截统计
   ```
   混排生成完成，共 50 个文档
   查重统计: 拦截 3 次重复, 总尝试 53 次
   ```

### 3️⃣ 管理指纹库

在 **"历史查重"** 配置对话框中，点击 **"管理指纹库"** 按钮：

#### 📊 查看统计
- **总记录数**：当前指纹库的记录总数
- **近7天新增**：最近一周新增的指纹数
- **最早/最新记录**：指纹库的时间范围
- **项目分布**：各项目的记录数量

#### 🛠️ 管理操作
- **刷新统计**：重新加载最新数据
- **清理旧数据**：删除超过保留天数的指纹（默认 180 天）
- **清空指纹库**：⚠️ 危险操作，删除所有指纹（不可恢复）

---

## 🔬 技术原理

### SimHash 算法

SimHash 是一种局部敏感哈希算法，用于快速检测文本相似度：

1. **分词**：将文本按 2-gram 和 3-gram 切分
2. **哈希**：对每个词计算 MD5 哈希
3. **向量累加**：构建 64 维权重向量
4. **降维**：将向量转为 64-bit 二进制指纹

### 海明距离

两个 SimHash 的海明距离（不同位数）反映了内容相似度：

| 海明距离 | 相似度 | 说明 |
|---------|--------|------|
| 0 | 100% | 完全相同 |
| 1-3 | 95%+ | 高度相似 |
| 4-6 | 90%+ | 相似（推荐阈值） |
| 7-10 | 85%+ | 较相似 |
| >10 | <85% | 差异较大 |

### 性能优化

- **索引优化**：`fingerprint` 字段建立 B-tree 索引
- **复合索引**：`(source_project, fingerprint)` 加速项目查询
- **批量查询**：支持一次查询多个指纹（未来扩展）
- **SQLite WAL 模式**：提高并发读写性能

---

## ⚙️ 配置文件

查重配置保存在 `profile.json` 中：

```json
{
  "dedup_enabled": false,
  "dedup_similarity_threshold": 0.90,
  "dedup_max_retries": 10,
  "dedup_retention_days": 180,
  "dedup_cross_project": false,
  "dedup_current_project": "default"
}
```

---

## 📊 数据库结构

### content_fingerprints 表

| 字段 | 类型 | 说明 |
|-----|------|-----|
| id | Integer | 主键 |
| fingerprint | String(20) | SimHash 指纹（索引） |
| content_preview | String(200) | 内容预览（前100字） |
| full_content_hash | String(32) | 全文MD5哈希（精确匹配） |
| source_project | String(100) | 来源项目（索引） |
| document_path | String(500) | 文档相对路径 |
| word_count | Integer | 字数统计 |
| created_at | DateTime | 创建时间（索引） |

### 索引

- `idx_fingerprint`：单列索引（快速查找相似指纹）
- `idx_source_project`：项目过滤索引
- `idx_project_fingerprint`：复合索引（项目+指纹）
- `idx_created_at`：时间索引（清理旧数据）

---

## 💡 使用建议

### 相似度阈值设置

| 场景 | 推荐阈值 | 说明 |
|-----|---------|-----|
| **严格去重** | 95%（距离≤3） | 适合高质量原创内容 |
| **平衡模式** | 90%（距离≤6） | 推荐，平衡唯一性和生成效率 |
| **宽松模式** | 85%（距离≤10） | 允许一定程度的相似 |

### 项目管理策略

#### 场景1：多产品/多类目
- **查重范围**：仅当前项目
- **项目名称**：按产品或类目命名（如：洗地机、吸尘器）
- **优势**：同类产品可以复用素材，不同产品间独立

#### 场景2：统一品牌内容
- **查重范围**：全局所有项目
- **优势**：确保全站内容唯一性，避免自我抄袭

### 定期维护

建议每月执行一次 **"清理旧数据"**，保持查询性能：

- **保留天数**：根据内容更新频率调整
  - 快速更新（每周）：30-90 天
  - 中等更新（每月）：180 天（默认）
  - 慢速更新（每季度）：365 天

---

## 🚨 注意事项

1. **首次启用**：旧文档不会自动添加指纹，只对新生成的文档生效
2. **重试次数**：设置过低可能导致部分文档跳过，设置过高会延长生成时间
3. **项目名称**：一旦确定，不要随意更改，否则会影响查重范围
4. **清空操作**：不可恢复，执行前请三思

---

## 🔧 故障排查

### 问题1：查重不生效

**检查清单**：
- ✅ 是否启用了查重开关？
- ✅ 是否保存了配置？
- ✅ 是否使用 "随机混排" 模式？（按行生成不支持查重）

### 问题2：生成速度变慢

**可能原因**：
- 指纹库记录过多（> 10 万条）
- 相似度阈值过高（重试次数过多）

**解决方案**：
- 执行 "清理旧数据"
- 降低相似度阈值（如从 95% 降到 90%）
- 缩短保留天数

### 问题3：误判为重复

**可能原因**：
- 相似度阈值过高（90% 以上）
- 素材库内容过于相似

**解决方案**：
- 降低相似度阈值
- 丰富素材库，增加多样性

---

## 📈 性能指标

### 基准测试

| 指纹库大小 | 查重耗时 | 内存占用 |
|-----------|---------|---------|
| 1,000 条 | < 10ms | ~5MB |
| 10,000 条 | < 50ms | ~30MB |
| 100,000 条 | < 100ms | ~150MB |

### 生成速度影响

- **未启用查重**：50 篇/分钟
- **启用查重（无重复）**：48 篇/分钟（约 -4%）
- **启用查重（10% 重复率）**：45 篇/分钟（约 -10%）

---

## 🎓 FAQ

**Q1: SimHash 和 MD5 有什么区别？**  
A: MD5 是精确匹配（完全相同才能检测），SimHash 可以检测相似内容（如改几个字）。

**Q2: 海明距离 ≤ 6 是什么意思？**  
A: 两个 64-bit 指纹中，不同的位数不超过 6 位，相似度约为 90%。

**Q3: 查重会影响已生成的旧文档吗？**  
A: 不会。查重只对新生成的文档生效，旧文档不受影响。

**Q4: 可以导出指纹库吗？**  
A: 指纹库存储在 `assets.db` 中，可以备份整个数据库文件。

**Q5: 跨设备如何同步指纹库？**  
A: 将 `assets.db` 文件复制到另一台设备即可。

---

## 📞 技术支持

如有问题，请查看日志文件：`logs/seo_workbench_YYYY-MM-DD.log`

关键日志标识：
- `✓ 历史查重功能已启用`
- `⚠ 检测到重复内容`
- `✓ 指纹已记录`
- `查重统计: 拦截 X 次重复`

---

**版本信息**：v1.4  
**更新日期**：2025-12-03  
**作者**：AI 助手 + SEO Workbench 团队

