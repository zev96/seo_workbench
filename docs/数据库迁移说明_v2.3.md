# 数据库迁移说明 - v2.3 更新

## 问题描述

在 v2.3 版本中，我们为 `zhihu_monitor_configs` 表添加了两个新字段：
- `chromedriver_path`：ChromeDriver 可执行文件路径
- `anti_detect_level`：反检测强度（low/medium/high）

如果你是从旧版本升级到 v2.3，数据库表结构还没有这些新字段，会出现以下错误：

```
sqlite3.OperationalError: no such column: zhihu_monitor_configs.anti_detect_level
```

## 解决方案（自动迁移）

### ✅ 方案 A：重启应用（推荐）

**操作步骤**：
1. 完全关闭应用
2. 重新启动应用

**原理**：
程序启动时会自动检测数据库是否需要迁移，并自动添加缺失的字段。

**预期日志输出**：
```
[INFO] 检测到数据库需要迁移，开始执行迁移...
[INFO] 开始数据库迁移...
[INFO] 添加字段: zhihu_monitor_configs.chromedriver_path
[SUCCESS] ✅ 已添加字段: chromedriver_path
[INFO] 添加字段: zhihu_monitor_configs.anti_detect_level
[SUCCESS] ✅ 已添加字段: anti_detect_level
[SUCCESS] 数据库迁移完成
```

---

### ✅ 方案 B：手动执行迁移脚本

如果重启后仍有问题，可以手动执行迁移脚本：

**操作步骤**：

1. 打开命令行（CMD 或 PowerShell）
2. 切换到项目目录：
   ```bash
   cd E:\Case-5\seo_workbench
   ```

3. 执行迁移脚本：
   ```bash
   python -m database.migrations assets.db
   ```

**预期输出**：
```
测试数据库迁移: assets.db
需要执行迁移
[INFO] 开始数据库迁移...
[INFO] 添加字段: zhihu_monitor_configs.chromedriver_path
[SUCCESS] ✅ 已添加字段: chromedriver_path
[INFO] 添加字段: zhihu_monitor_configs.anti_detect_level
[SUCCESS] ✅ 已添加字段: anti_detect_level
[SUCCESS] 数据库迁移完成
```

---

## 迁移脚本详情

### 迁移内容

**文件**：`database/migrations.py`

**执行的 SQL 操作**：
```sql
-- 添加 chromedriver_path 字段
ALTER TABLE zhihu_monitor_configs 
ADD COLUMN chromedriver_path VARCHAR(500);

-- 添加 anti_detect_level 字段（默认值：medium）
ALTER TABLE zhihu_monitor_configs 
ADD COLUMN anti_detect_level VARCHAR(20) DEFAULT 'medium';
```

### 安全性

- ✅ **非破坏性**：只添加新字段，不删除或修改现有数据
- ✅ **幂等性**：可以重复执行，已存在的字段会自动跳过
- ✅ **事务保护**：出错时会自动回滚

---

## 验证迁移是否成功

### 方法 1：查看日志

重启应用后，查看日志输出，应该看到：
```
[SUCCESS] ✅ 已添加字段: chromedriver_path
[SUCCESS] ✅ 已添加字段: anti_detect_level
[SUCCESS] 数据库迁移完成
```

### 方法 2：测试保存设置

1. 打开应用
2. 进入"知乎监测" → "设置"
3. 配置 ChromeDriver 路径
4. 选择反检测强度
5. 点击"保存设置"

**如果成功**：
- ✅ 显示"配置已保存"
- ✅ 不再出现错误提示

**如果仍然失败**：
- ⚠️ 请查看下方的"常见问题"

---

## 常见问题

### Q1: 重启后仍然报错

**可能原因**：
- 数据库文件被锁定
- 数据库文件权限不足

**解决方案**：
1. 完全关闭应用（包括托盘图标）
2. 检查任务管理器，确保没有残留进程
3. 手动执行迁移脚本（参考"方案B"）
4. 重启应用

---

### Q2: 迁移脚本执行失败

**错误提示**：
```
database is locked
```

**解决方案**：
1. 关闭所有访问数据库的程序
2. 重启电脑（清理所有锁定）
3. 重新执行迁移

---

### Q3: 找不到 assets.db 文件

**解决方案**：
1. 查找数据库文件位置：
   - 通常在项目根目录：`E:\Case-5\seo_workbench\assets.db`
   - 或在应用安装目录

2. 确认文件路径后，修改迁移命令：
   ```bash
   python -m database.migrations "完整路径\assets.db"
   ```

---

### Q4: 想要手动添加字段（高级用户）

**操作步骤**：

1. 使用 SQLite 客户端（如 DB Browser for SQLite）
2. 打开 `assets.db` 数据库
3. 执行以下 SQL：

```sql
-- 检查字段是否已存在
PRAGMA table_info(zhihu_monitor_configs);

-- 如果 chromedriver_path 不存在，执行：
ALTER TABLE zhihu_monitor_configs 
ADD COLUMN chromedriver_path VARCHAR(500);

-- 如果 anti_detect_level 不存在，执行：
ALTER TABLE zhihu_monitor_configs 
ADD COLUMN anti_detect_level VARCHAR(20) DEFAULT 'medium';
```

---

## 技术细节

### 迁移触发时机

程序启动时会自动检查：
1. 数据库文件是否存在
2. `zhihu_monitor_configs` 表是否存在
3. 表中是否缺少新字段

如果满足以上条件，自动执行迁移。

### 迁移代码位置

- **迁移脚本**：`database/migrations.py`
- **调用位置**：`database/init_db.py` 的 `init_database()` 函数
- **检查函数**：`check_migration_needed()`
- **执行函数**：`migrate_database()`

---

## 总结

**推荐操作**：
1. ✅ **直接重启应用**（程序会自动迁移）
2. ✅ 查看日志确认迁移成功
3. ✅ 测试保存设置功能

**如果重启无效**：
1. ⚠️ 手动执行迁移脚本
2. ⚠️ 检查数据库文件权限
3. ⚠️ 联系技术支持

---

**更新时间**：2024-12-03  
**版本**：v2.3  
**影响范围**：从旧版本升级到 v2.3 的用户

