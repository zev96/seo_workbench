# 文档生成进度可视化功能

## 功能概述

为SEO智能内容工作台添加了实时进度可视化功能，提供友好的用户体验，让用户可以实时看到文档生成的进度。

## 主要特性

### 1. 实时进度显示
- **进度条**：显示当前生成进度的百分比
- **状态信息**：显示当前正在处理的文档编号和总数
- **详细信息**：显示当前操作的详细描述

### 2. 异步处理
- 使用后台线程处理文档生成任务
- 避免UI冻结，保持界面响应
- 支持取消操作

### 3. Fluent Design 风格
- 与整体应用保持一致的UI风格
- 使用 qfluentwidgets 组件
- 现代化的磨砂玻璃效果

### 4. 用户友好
- 清晰的进度反馈
- 支持中途取消
- 完成后自动显示结果通知

## 技术实现

### 新增文件

#### 1. `core/generation_worker.py`
后台工作线程类，负责：
- 异步执行文档生成任务
- 发送进度更新信号
- 处理取消请求
- 错误处理和异常捕获

```python
class GenerationWorker(QThread):
    """文档生成工作线程"""
    
    # 信号定义
    progress_updated = pyqtSignal(int, int, str)  # (current, total, detail)
    status_changed = pyqtSignal(str)  # status message
    generation_complete = pyqtSignal(bool, str, int)  # (success, message, count)
    error_occurred = pyqtSignal(str)  # error message
```

#### 2. `ui/dialogs/progress_dialog.py` (重构)
Fluent Design 风格的进度对话框，提供：
- 美观的进度条显示
- 状态和详细信息标签
- 取消按钮
- 完成状态显示

```python
class ProgressDialog(MessageBoxBase):
    """进度对话框 - Fluent Design 风格"""
    
    # 信号
    cancelled = pyqtSignal()
    
    # 方法
    def set_progress(current, total)
    def set_status(status)
    def set_detail(detail)
    def complete(success, message)
```

### 修改的文件

#### `ui/main_window.py`
- 修改 `_on_generate` 方法，使用新的进度对话框和工作线程
- 新增 `_on_generation_complete` 方法处理生成完成事件
- 新增 `_generate_documents_with_progress` 方法作为包装
- 修改 `_generate_documents` 方法，添加 `progress_callback` 参数支持
- 在文档生成循环中调用进度回调

## 使用流程

1. **用户点击"开始生成 Word"按钮**
   - 系统验证工作区数据
   - 用户选择保存目录

2. **显示进度对话框**
   - 对话框自动弹出
   - 显示初始状态

3. **后台生成文档**
   - 工作线程开始执行任务
   - 实时更新进度信息
   - 每生成一个文档更新一次进度

4. **用户可以取消**
   - 点击"取消"按钮
   - 系统安全停止生成
   - 已生成的文档保留

5. **生成完成**
   - 进度条达到100%
   - 显示完成消息
   - 弹出成功通知

## 界面展示

### 进度对话框界面元素
- **标题**：正在生成文档
- **状态标签**：正在处理: X/Y (Z%)
- **进度条**：视觉化进度显示
- **详细信息**：正在生成第 X 个文档...
- **取消按钮**：允许用户中断操作

### 进度更新频率
- 每生成一个文档更新一次
- 包含当前进度、总数、百分比
- 显示当前正在处理的文档信息

## 代码示例

### 如何使用进度对话框

```python
from ui.dialogs.progress_dialog import ProgressDialog

# 创建对话框
progress_dialog = ProgressDialog(
    title="正在生成文档",
    total=100,  # 总任务数
    parent=self
)

# 更新进度
progress_dialog.set_progress(50, 100)

# 更新详细信息
progress_dialog.set_detail("正在处理第50个文档...")

# 完成
progress_dialog.complete(success=True, message="生成完成！")
```

### 如何创建工作线程

```python
from core.generation_worker import GenerationWorker

# 创建工作线程
worker = GenerationWorker(
    grid_data=data,
    save_dir=output_dir,
    mode="row",
    count=100,
    config=config,
    generate_func=self._generate_documents_with_progress,
    parent=self
)

# 连接信号
worker.progress_updated.connect(on_progress)
worker.generation_complete.connect(on_complete)

# 启动
worker.start()
```

## 错误处理

### 异常捕获
- 所有异常在工作线程中捕获
- 通过 `error_occurred` 信号报告
- 不会导致程序崩溃

### 取消操作
- 检查 `_is_cancelled` 标志
- 抛出 `InterruptedError` 中断生成
- 已生成的文档保留

### 用户通知
- 成功：绿色通知，显示生成数量
- 失败：红色通知，显示错误信息
- 取消：黄色通知，提示已取消

## 性能优化

1. **异步执行**：不阻塞UI线程
2. **批量处理**：按文档逐个生成和更新
3. **最小化信号**：避免过度更新UI
4. **内存管理**：及时释放文档对象

## 未来改进方向

1. **批量进度显示**：支持多任务并行
2. **速度预测**：预估剩余时间
3. **历史记录**：保存生成历史
4. **断点续传**：支持暂停和恢复
5. **详细日志**：可导出的生成日志

## 兼容性

- **PyQt6**：6.0+
- **qfluentwidgets**：1.0+
- **Windows 10/11**：完全支持Mica效果
- **其他系统**：降级到标准样式

## 总结

进度可视化功能大幅提升了用户体验，让文档生成过程更加透明和可控。通过异步处理和友好的界面设计，确保了应用的响应性和专业性。

