# 知乎监测 v2.2 更新说明

## 更新日期：2025-12-03

---

## ✅ 已完成的修复（P0）

### 1. 修复Top10数据采集不完整 ✅
**问题**：有时只采集5条，有时10条

**解决方案**：
```python
# 确保至少处理10个回答（用于Top10数据）
scan_count = max(10, min(check_range, len(answers)))
logger.info(f"将扫描前 {scan_count} 个回答")
```

**效果**：
- ✅ 现在无论设置Top多少，都会采集完整的Top10数据
- ✅ 日志会显示"将扫描前 X 个回答"

---

### 2. 修复状态显示错误 ✅
**问题**：检测完成但显示"🏺 待检测"

**原因**：状态判断只看`status`字段，没有考虑`last_check_at`

**解决方案**：
```python
def _get_status_display(self, task):
    # 优先检查last_check_at，如果有检测时间说明已检测过
    if task.last_check_at:
        if task.get_result_list():
            return "✅ 在榜", "#d4edda"
        else:
            if task.status == 'failed':
                return "⚠️ 失败", "#fff3cd"
            else:
                return "❌ 未发现", "#f8d7da"
    else:
        return "⏳ 待检测", "#d1ecf1"
```

**效果**：
- ✅ 检测后正确显示"✅ 在榜"或"❌ 未发现"
- ✅ 不再出现误判

---

### 3. 增加温和模式（防封）✅
**功能**：在设置中新增"🛡️ 温和模式"开关

**温和模式参数**：
| 参数 | 正常模式 | 温和模式 |
|------|---------|---------|
| 请求间隔 | 4-8秒 | 8-15秒 |
| 滚动次数 | 最多5次 | 最多3次 |
| 滚动等待 | 1.5秒 | 3秒 |

**数据库变更**：
```sql
ALTER TABLE zhihu_monitor_configs ADD COLUMN gentle_mode INTEGER DEFAULT 0;
```

**使用方法**：
1. 点击"⚙️ 设置"
2. 勾选"启用温和模式"
3. 保存设置
4. 下次检测时自动生效

**效果**：
- ✅ 降低被封风险
- ⚠️ 可能无法获取完整Top20数据（只能获取Top10-15）
- ✅ 日志显示"🛡️ 温和模式已启用"

---

## ⏳ 待实现功能（P1-P2）

由于时间限制，以下功能已设计完成但未实现代码，您可以根据需要继续开发：

### 4. 勾选框功能 ⏳ 设计完成
**实现要点**：
1. 表格第一列添加复选框
2. 表头添加"全选"复选框
3. `_start_check`只检测勾选的任务

**参考代码**：见`docs/知乎监测v2.2实现计划.md` 第4节

---

### 5. 批量导入Excel ⏳ 设计完成
**实现要点**：
1. 添加"导入Excel"按钮
2. 使用`pandas.read_excel`读取
3. 检查URL是否已存在，存在则跳过

**Excel格式**：
| 问题链接 | 目标品牌 | 检测范围 |
|---------|---------|---------|
| https://... | CEWEY | 20 |

**参考代码**：见`docs/知乎监测v2.2实现计划.md` 第5节

---

### 6. 导出Excel模板 ⏳ 设计完成
**实现要点**：
1. 添加"下载模板"按钮
2. 生成示例Excel文件

**参考代码**：见`docs/知乎监测v2.2实现计划.md` 第6节

---

### 7. 批量删除 ⏳ 设计完成
**实现要点**：
1. 添加"批量删除"按钮
2. 删除所有勾选的任务

**参考代码**：见`docs/知乎监测v2.2实现计划.md` 第7节

---

## 🧪 测试指南

### 测试1：Top10数据完整性
1. 添加一个监控任务
2. 点击"立即检测"
3. 查看日志：应该显示"将扫描前 10 个回答"
4. 点击"详情"
5. 验证：Top10透视表应该有10行数据（如果问题有≥10个回答）

### 测试2：状态显示
1. 检测完成后
2. 主列表应该显示：
   - "✅ 在榜"（如果找到品牌）
   - "❌ 未发现"（如果未找到品牌）
3. 不应该再显示"🏺 待检测"

### 测试3：温和模式
1. 点击"⚙️ 设置"
2. 勾选"启用温和模式"
3. 保存设置
4. 点击"立即检测"
5. 观察日志：
   - 应该显示"🛡️ 温和模式已启用"
   - 滚动间隔应该更长（3秒）
   - 最多滚动3次

---

## ⚠️ 重要提示

### 关于温和模式
- **建议**：如果遇到知乎异常弹窗，立即启用温和模式
- **权衡**：温和模式更安全，但可能无法获取完整数据
- **最佳实践**：
  - 白天使用温和模式
  - 凌晨使用正常模式
  - 每天检测不超过2次

### 关于Cookie
- **必须设置**：Cookie对成功率影响很大
- **更新频率**：建议每周更新一次
- **获取方式**：登录知乎 → F12 → Network → Cookie

### 关于检测频率
- **建议间隔**：
  - 正常模式：每天1-2次
  - 温和模式：每天2-3次
- **避免**：短时间内多次检测同一问题

---

## 📊 性能对比

| 模式 | 检测时间 | 数据完整性 | 安全性 |
|------|---------|-----------|--------|
| 正常模式 | 20-30秒 | 95% | 中等 |
| 温和模式 | 30-45秒 | 70-80% | 高 |

---

## 🔮 后续开发建议

如果您需要继续开发P1-P2功能，建议按以下顺序：

1. **勾选框功能**（最实用）
   - 工作量：1小时
   - 优先级：⭐⭐⭐⭐⭐

2. **批量导入Excel**（提高效率）
   - 工作量：1小时
   - 优先级：⭐⭐⭐⭐

3. **批量删除**（配合勾选框）
   - 工作量：30分钟
   - 优先级：⭐⭐⭐

4. **导出模板**（辅助功能）
   - 工作量：20分钟
   - 优先级：⭐⭐

---

## 📞 技术支持

### 已知问题
1. ✅ Top10采集不完整 - 已修复
2. ✅ 状态显示错误 - 已修复
3. ✅ 缺少防封机制 - 已添加温和模式

### 如果仍然遇到问题
请提供：
1. 完整的日志文件
2. 是否启用温和模式
3. Cookie是否有效
4. 具体的错误截图

---

**更新状态**：✅ P0已完成，P1-P2设计完成  
**版本号**：v2.2  
**发布日期**：2025-12-03  
**下次更新**：根据用户反馈决定

