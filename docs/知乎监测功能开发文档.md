# 知乎监测功能开发文档

## 📐 架构设计

### 技术栈
- **前端框架**：PyQt6 + qfluentwidgets
- **爬虫引擎**：Selenium + Chrome WebDriver
- **数据库**：SQLAlchemy ORM + SQLite
- **异步处理**：QThread多线程
- **数据导出**：pandas + openpyxl

---

## 🗂️ 文件结构

```
seo_workbench/
├── core/
│   ├── zhihu_monitor_worker.py      # 爬虫核心（基础检测+详情扫描）
│   └── zhihu_scheduler.py           # 定时任务调度器
├── database/
│   ├── models.py                    # 新增4个表定义
│   └── init_db.py                   # 数据库初始化
├── ui/
│   ├── widgets/
│   │   └── zhihu_monitor.py         # 主监控页面
│   └── dialogs/
│       ├── brand_manager_dialog.py   # 品牌管理对话框
│       ├── zhihu_settings_dialog.py  # 设置对话框
│       └── zhihu_detail_dialog.py    # 详情分析对话框
├── docs/
│   ├── 知乎监测功能使用指南.md       # 用户手册
│   └── 知乎监测功能开发文档.md       # 开发文档（本文件）
└── requirements.txt                  # 新增selenium依赖
```

---

## 🗄️ 数据库设计

### 1. zhihu_brands（品牌词库表）
```sql
CREATE TABLE zhihu_brands (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    brand_type TEXT DEFAULT 'competitor',  -- 'own' | 'competitor'
    regex_pattern TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**用途**：存储我方品牌和竞品关键词

---

### 2. zhihu_monitor_tasks（监控任务表）
```sql
CREATE TABLE zhihu_monitor_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    question_url TEXT NOT NULL,
    question_title TEXT,
    target_brand TEXT NOT NULL,
    check_range INTEGER DEFAULT 20,
    
    -- 状态字段
    status TEXT DEFAULT 'pending',  -- 'pending' | 'success' | 'failed'
    last_result TEXT,  -- JSON: [1, 5, 12]
    top10_snapshot TEXT,  -- JSON: 详细快照
    total_views INTEGER DEFAULT 0,
    total_followers INTEGER DEFAULT 0,
    
    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_check_at DATETIME,
    
    -- 定时任务
    schedule_enabled INTEGER DEFAULT 0,  -- 0=禁用, 1=启用
    schedule_time TEXT  -- "HH:MM"
);
```

**字段说明**：
- `last_result`：简单排名数组，用于快速展示
- `top10_snapshot`：完整Top10数据，用于详情页

---

### 3. zhihu_monitor_histories（历史记录表）
```sql
CREATE TABLE zhihu_monitor_histories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    check_result TEXT,  -- JSON
    total_views INTEGER DEFAULT 0,
    total_followers INTEGER DEFAULT 0,
    snapshot_data TEXT,  -- JSON
    check_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES zhihu_monitor_tasks(id)
);
```

**用途**：记录每次检测的历史快照，支持趋势分析

---

### 4. zhihu_monitor_configs（配置表）
```sql
CREATE TABLE zhihu_monitor_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    cookie TEXT,
    user_agent TEXT,
    request_delay_min INTEGER DEFAULT 2,
    request_delay_max INTEGER DEFAULT 6,
    retry_count INTEGER DEFAULT 3,
    retry_delay INTEGER DEFAULT 600,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**用途**：存储Cookie、防封策略等全局配置

---

## 🧩 核心模块

### 1. ZhihuMonitorWorker（基础检测工作线程）

**职责**：
- 串行处理多个监控任务
- 检测品牌在Top N中的排名
- 防封策略（User-Agent轮换、请求延迟）
- 异常处理（403/429自动停止）

**关键方法**：
```python
def _check_question(url, target_brand, check_range) -> dict:
    """
    检测单个问题
    返回：
    {
        'question_title': str,
        'total_views': int,
        'total_followers': int,
        'found_ranks': [1, 5, 12],
        'status': 'success' | 'not_found'
    }
    """
```

**信号**：
- `progress_updated(current, total, message)`
- `task_completed(task_id, result)`
- `task_failed(task_id, error)`
- `all_completed()`

---

### 2. ZhihuDetailedWorker（详情扫描工作线程）

**职责**：
- 全量扫描Top 10回答
- 提取赞同数、评论数、答主信息
- 智能品牌归属识别

**关键方法**：
```python
def _scan_question_detail(url) -> dict:
    """
    返回：
    {
        'question_title': str,
        'total_views': int,
        'total_followers': int,
        'top10': [
            {
                'rank': 1,
                'author': '答主昵称',
                'mentioned_brand': 'CEWEY',
                'vote_count': 1234,
                'comment_count': 56,
                'summary': '回答摘要...'
            },
            ...
        ]
    }
    """
```

**品牌识别逻辑**：
1. 优先匹配我方品牌
2. 其次匹配竞品品牌
3. 未匹配则标记为"未提及"

---

### 3. ZhihuScheduler（定时调度器）

**职责**：
- 后台循环检查定时任务
- 每分钟扫描一次数据库
- 到达设定时间后触发检测
- 避免同一天重复执行

**调度逻辑**：
```python
while not stop_flag:
    current_time = datetime.now()
    tasks = query_enabled_tasks()
    
    for task in tasks:
        if is_time_to_execute(task.schedule_time):
            if not executed_today(task):
                execute_scheduled_tasks()
                sleep(120)  # 避免重复触发
    
    sleep(60)  # 检查间隔
```

---

## 🎨 UI组件

### 1. ZhihuMonitorWidget（主监控页面）

**布局**：
```
+--------------------------------------------------+
| [➕添加] [🔄检测] [⬇️导出] [🏷️品牌] [⚙️设置]   共X个任务 |
+--------------------------------------------------+
| [进度条 - 检测时显示]                               |
+--------------------------------------------------+
| 问题标题 | 品牌 | 状态 | 排名 | 浏览/关注 | 更新 | 操作 |
| -------- | ---- | ---- | ---- | -------- | ---- | ---- |
| XXX问题  | CEWEY| ✅在榜| 3,8  | 12万/5k  | 12:30| 📊⏰🗑️|
+--------------------------------------------------+
```

**操作按钮**：
- 📊 详情：打开详情分析弹窗
- ⏰ 定时：配置定时任务（绿色=已启用）
- 🗑️ 删除：删除监控任务

---

### 2. BrandManagerDialog（品牌管理）

**功能**：
- 添加/删除品牌
- 区分我方品牌（绿色高亮）和竞品
- 支持正则表达式

---

### 3. ZhihuSettingsDialog（设置）

**配置项**：
- Cookie输入框（多行）
- User-Agent（可选）
- 请求间隔（最小-最大）
- 重试策略（次数、间隔）

---

### 4. ZhihuDetailDialog（详情分析）

**区域A - 流量概览**：
- 统计卡片（浏览量/关注者/我方排名/更新时间）
- 可点击标题跳转知乎

**区域B - Top10透视表**：
- 5列：排名/品牌/赞同/评论/答主
- 我方品牌整行绿色高亮
- 竞品品牌加粗
- 支持刷新数据

---

## 🔐 防封策略

### 1. User-Agent轮换
```python
USER_AGENTS = [
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...',
    # 4个常见浏览器UA
]
```

每次请求随机选择

---

### 2. 请求间隔
```python
delay = random.uniform(delay_min, delay_max)  # 2-6秒
time.sleep(delay)
```

模拟人类阅读行为

---

### 3. Cookie支持
- 登录态访问，提高成功率
- 某些回答需要登录可见

---

### 4. 异常处理
```python
if response_code in [403, 429]:
    stop_all_tasks()
    show_warning("访问过于频繁，已暂停")
```

立即停止，避免IP被封

---

### 5. 串行队列
- 严禁并发请求
- 逐个处理任务
- 任务间强制延迟

---

## 🧪 测试建议

### 单元测试
1. **品牌匹配算法**
   - 测试精确匹配
   - 测试正则表达式
   - 测试优先级（我方>竞品）

2. **数字解析**
   - 测试"1.2万"、"1234"、"1.2K"等格式

3. **Cookie解析**
   - 测试分号分隔
   - 测试特殊字符

---

### 集成测试
1. **完整流程**
   - 添加监控 → 执行检测 → 查看详情 → 导出报告

2. **边界条件**
   - 无Cookie时的表现
   - 403错误的处理
   - 空数据的显示

3. **定时任务**
   - 时间触发准确性
   - 避免重复执行
   - 调度器重启后恢复

---

## 📊 性能优化

### 1. 图片禁用
```python
prefs = {
    'profile.managed_default_content_settings.images': 2
}
```
提速30-50%

---

### 2. CSS禁用
```python
prefs = {
    'permissions.default.stylesheet': 2
}
```
减少渲染开销

---

### 3. 无头模式（可选）
```python
chrome_options.add_argument('--headless')
```
节省资源，适合定时任务

---

### 4. 数据库索引
```sql
CREATE INDEX idx_question_url ON zhihu_monitor_tasks(question_url);
CREATE INDEX idx_task_check ON zhihu_monitor_histories(task_id, check_at);
```

---

## 🐛 已知问题

### 1. Selenium启动慢
**原因**：首次下载ChromeDriver
**解决**：使用webdriver-manager自动管理

---

### 2. 知乎页面结构变化
**影响**：CSS选择器失效
**解决方案**：
- 使用多层try-except容错
- 提供手动导入数据功能（未来）

---

### 3. 内存占用
**原因**：Selenium保持浏览器实例
**解决**：
- 检测完成后立即清理
- 禁用图片和CSS

---

## 🔮 扩展方向

### 短期（1-2周）
- [ ] 排名趋势折线图
- [ ] 批量导入监控链接
- [ ] 导出历史趋势报告

### 中期（1个月）
- [ ] 微信通知（排名变化时推送）
- [ ] 邮件报告（每周自动发送）
- [ ] 竞品对比分析

### 长期（3个月）
- [ ] 支持更多平台（小红书、抖音）
- [ ] AI智能分析（回答质量评分）
- [ ] 数据可视化Dashboard

---

## 📞 开发支持

### 调试技巧
1. **查看日志**：`logs/seo_workbench_*.log`
2. **SQL调试**：启用SQLAlchemy echo
   ```python
   engine = create_engine(db_url, echo=True)
   ```
3. **Selenium调试**：关闭无头模式，观察浏览器操作

### 代码规范
- 遵循PEP 8
- 使用类型提示
- 详细的docstring
- 单一职责原则

---

## 📝 总结

知乎监测模块采用 **分层架构 + 异步处理** 的设计，具备：
- ✅ 高可靠性（异常处理完善）
- ✅ 高扩展性（模块化设计）
- ✅ 高性能（多线程+优化策略）
- ✅ 高可用性（防封+自动重试）

**代码总量**：约 2500 行
**开发周期**：3个Phase，约3小时
**维护成本**：低（数据库驱动，配置化）

---

## 🎓 学习要点

如果您想理解或修改代码，建议学习路径：

1. **核心流程**：`zhihu_monitor_worker.py` → `_check_question()`
2. **UI交互**：`zhihu_monitor.py` → `_start_check()`
3. **数据持久化**：`models.py` → 4个新表
4. **定时调度**：`zhihu_scheduler.py` → `run()`

---

**Happy Coding! 🚀**

